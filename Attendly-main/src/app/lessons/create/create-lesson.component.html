<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="cancel()">CANCELAR</ion-button>
    </ion-buttons>
    <ion-title>{{ lessonData ? 'Editar Aula' : 'Nova Aula' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="lessonData?.id" fill="clear" color="danger" (click)="confirmDelete()">
        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="saveLesson()" [strong]="true" [disabled]="lessonForm.invalid">SALVAR</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [scrollY]="true" class="form-content">
	<div class="form-container">
		<form [formGroup]="lessonForm" (ngSubmit)="saveLesson()">

			<!-- Lesson Header Section -->
			<div class="profile-photo-section">
				<div class="photo-container">
					<div class="photo-preview" [class.has-image]="lessonImage">
						@if (lessonImage) {
							<img [src]="lessonImage" alt="Lesson" />
						} @else {
							<ion-icon name="fitness-outline"></ion-icon>
						}
					</div>
					<input type="file" #fileInput accept="image/*" (change)="onImageSelect($event)"
						style="display: none" />
					<ion-button fill="outline" size="small" (click)="fileInput.click()" class="upload-btn">
						<ion-icon slot="start" name="camera-outline"></ion-icon>
						UPLOAD PHOTO
					</ion-button>
					@if (lessonImage) {
						<ion-button fill="clear" size="small" color="danger" (click)="removeImage()">
							Remove
						</ion-button>
					}
				</div>
			</div>

			<!-- Lesson Information -->
			<div class="section-header">
				<ion-icon name="information-circle-outline"></ion-icon>
				<h2>Lesson Information</h2>
			</div>

			<ion-item class="form-item" [class.error]="title?.invalid && title?.touched">
				<ion-label position="stacked">Lesson Title *</ion-label>
				<ion-input formControlName="title" placeholder="Ex: Guarda Fechada - Fundamentos" type="text"></ion-input>
			</ion-item>
			<div class="error-message" *ngIf="title?.invalid && title?.touched">
				<span *ngIf="title?.errors?.['required']">Lesson title is required</span>
				<span *ngIf="title?.errors?.['minlength']">Title must be at least 3 characters</span>
			</div>

			<ion-item class="form-item textarea-item">
				<ion-label position="stacked">Description</ion-label>
				<ion-textarea formControlName="description"
					placeholder="Detailed description of the lesson..."
					rows="4" auto-grow="true"></ion-textarea>
			</ion-item>

			<!-- Jiu-Jitsu Information -->
			<div class="section-header">
				<ion-icon name="ribbon-outline"></ion-icon>
				<h2>Jiu-Jitsu Information</h2>
			</div>

			<ion-item class="form-item" [class.error]="category?.invalid && category?.touched">
				<ion-label position="stacked">Category *</ion-label>
				<ion-select formControlName="category" placeholder="Select category" interface="action-sheet">
					<ion-select-option *ngFor="let cat of categories" [value]="cat">
						{{ cat }}
					</ion-select-option>
				</ion-select>
			</ion-item>

			<ion-item class="form-item" [class.error]="beltLevel?.invalid && beltLevel?.touched">
				<ion-label position="stacked">Belt Level *</ion-label>
				<ion-select formControlName="beltLevel" placeholder="Select belt level" interface="popover">
					<ion-select-option *ngFor="let belt of beltLevels" [value]="belt">
						{{ belt }}
					</ion-select-option>
				</ion-select>
			</ion-item>

			<!-- Belt Preview -->
			<div class="belt-preview" *ngIf="beltLevel?.value">
				<div class="belt-display">
					<div class="belt" [ngStyle]="getBeltStyle(beltLevel.value)">
						<div class="stripes-container">
							<div class="stripe" *ngFor="let stripe of [].constructor(0)"></div>
						</div>
					</div>
					<p>{{ beltLevel.value }} Belt - Lesson</p>
				</div>
			</div>

			<!-- Lesson Details -->
			<div class="section-header">
				<ion-icon name="calendar-outline"></ion-icon>
				<h2>Lesson Details</h2>
			</div>

			<ion-item class="form-item" [class.error]="date?.invalid && date?.touched">
				<ion-label position="stacked">Lesson Date *</ion-label>
				<ion-input formControlName="date" type="date"></ion-input>
			</ion-item>

			<ion-item class="form-item" [class.error]="duration?.invalid && duration?.touched">
				<ion-label position="stacked">Duration (minutes) *</ion-label>
				<ion-input formControlName="duration" type="number" placeholder="60"
					min="30" max="180" (ionChange)="validateDuration()"></ion-input>
			</ion-item>
			<div class="error-message" *ngIf="duration?.invalid && duration?.touched">
				<span>Duration must be between 30 and 180 minutes</span>
			</div>

			<!-- Techniques Section -->
			<div class="section-header">
				<ion-icon name="list-outline"></ion-icon>
				<h2>Techniques</h2>
			</div>

			<!-- Add New Technique Form -->
			<div class="technique-form-section">
				<ion-item class="form-item">
					<ion-input formControlName="techName"
						label="Technique Name *"
						labelPlacement="stacked"
						placeholder="Ex: Armbar from guard">
					</ion-input>
				</ion-item>

				<ion-item class="form-item textarea-item">
					<ion-textarea formControlName="techDescription"
						label="Technique Description *"
						labelPlacement="stacked"
						placeholder="Step-by-step description..."
						rows="3" auto-grow="true">
					</ion-textarea>
				</ion-item>

				<ion-item class="form-item">
					<ion-input formControlName="techVideoUrl"
						label="Video URL (Optional)"
						labelPlacement="stacked"
						placeholder="https://...">
					</ion-input>
				</ion-item>

				<ion-button expand="block"
					(click)="addTechnique()"
					[disabled]="!techName?.value || !techDescription?.value"
					style="margin: 16px 0;">
					<ion-icon slot="start" name="add-circle-outline"></ion-icon>
					Add Technique
				</ion-button>
			</div>

			<!-- Techniques List -->
			<div *ngIf="techniques.length > 0" class="techniques-list">
				<ion-item>
					<ion-label><h3>Added Techniques ({{ techniques.length }})</h3></ion-label>
				</ion-item>

				<ion-card *ngFor="let technique of techniques; let i = index" class="technique-card">
					<ion-card-content>
						<div class="technique-header">
							<div class="technique-info">
								<h4>{{ technique.name }}</h4>
								<p>{{ technique.description }}</p>
								<div class="technique-links" *ngIf="technique.videoUrl">
									<ion-icon name="videocam-outline"></ion-icon>
									<span>Video attached</span>
								</div>
							</div>
							<ion-button fill="clear" color="danger" (click)="removeTechnique(i)">
								<ion-icon name="trash-outline"></ion-icon>
							</ion-button>
						</div>
					</ion-card-content>
				</ion-card>
			</div>

			<div *ngIf="techniques.length === 0" class="empty-state">
				<p>No techniques added yet. Add the techniques that will be taught in this lesson.</p>
			</div>

			<!-- EspaÃ§o extra para garantir scroll -->
			<div style="height: 100px;"></div>

			<!-- Action Buttons -->
			<div class="action-buttons">
				<ion-button expand="block" type="submit" [disabled]="lessonForm.invalid" class="submit-btn">
					<ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
					{{ lessonData ? 'Update Lesson' : 'Create Lesson' }}
				</ion-button>

				<ion-button expand="block" fill="outline" type="button" (click)="resetForm()" class="reset-btn">
					<ion-icon slot="start" name="refresh-outline"></ion-icon>
					Clear Form
				</ion-button>
			</div>

		</form>
	</div>
</ion-content>
